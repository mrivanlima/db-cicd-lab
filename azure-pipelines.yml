trigger:
- main

variables:
  TargetDatabaseName: "AppDb"

  DevServer: "localhost,14331"
  QaServer: "localhost,14332"
  StagingServer: "localhost,14333"
  ProdServer: "localhost,14334"

  SqlUser: "sa"

stages:

# =====================================================
# BUILD STAGE
# =====================================================
- stage: Build
  displayName: "Build DACPAC"
  jobs:
  - job: BuildDacpac
    displayName: "Compile SQL Database Project"
    pool:
      name: pool-local-docker
    steps:
    - checkout: self

    - task: VSBuild@1
      displayName: "Build SQL Project (.sqlproj)"
      inputs:
        solution: "database/**/*.sqlproj"
        vsVersion: "latest"
        configuration: "Release"

    - task: PublishBuildArtifacts@1
      displayName: "Publish DACPAC Artifact"
      inputs:
        PathtoPublish: "database"
        ArtifactName: "drop"
        publishLocation: "Container"

# =====================================================
# DEPLOY DEV
# =====================================================
- stage: Deploy_Dev
  displayName: "Deploy to Dev"
  dependsOn: Build
  jobs:
  - deployment: DeployDev
    displayName: "Publish DACPAC to Dev"
    environment: dev
    pool:
      name: pool-local-docker
    strategy:
      runOnce:
        deploy:
          steps:
          - download: current
            artifact: drop

          - powershell: |
              $dacpac = Get-ChildItem "$(Pipeline.Workspace)\drop" -Recurse -Filter "*.dacpac" | Select-Object -First 1
              if (-not $dacpac) { throw "No .dacpac found in artifact." }

              Write-Host "Using DACPAC: $($dacpac.FullName)"

              # ----------------------------
              # 1) Generate Deploy Report
              # ----------------------------
              $reportPath = "$(Pipeline.Workspace)\deploy-report-dev.xml"

              SqlPackage `
                /Action:DeployReport `
                /SourceFile:"$($dacpac.FullName)" `
                /TargetServerName:"$(DevServer)" `
                /TargetDatabaseName:"$(TargetDatabaseName)" `
                /TargetUser:"$(SqlUser)" `
                /TargetPassword:"$env:SQL_SA_PASSWORD" `
                /TargetEncryptConnection:True `
                /TargetTrustServerCertificate:True `
                /OutputPath:"$reportPath"

              Write-Host "Deploy report generated: $reportPath"

              # ----------------------------
              # 2) Publish DACPAC
              # ----------------------------
              SqlPackage `
                /Action:Publish `
                /SourceFile:"$($dacpac.FullName)" `
                /TargetServerName:"$(DevServer)" `
                /TargetDatabaseName:"$(TargetDatabaseName)" `
                /TargetUser:"$(SqlUser)" `
                /TargetPassword:"$env:SQL_SA_PASSWORD" `
                /TargetEncryptConnection:True `
                /TargetTrustServerCertificate:True `
                /p:BlockOnPossibleDataLoss=True `
                /p:VerifyDeployment=True
            displayName: "Deploy Dev (Safe Mode)"
            env:
              SQL_SA_PASSWORD: $(SQL_SA_PASSWORD)

          - task: PublishPipelineArtifact@1
            displayName: "Publish Dev deploy report"
            inputs:
              targetPath: "$(Pipeline.Workspace)/deploy-report-dev.xml"
              artifact: "deploy-report-dev"

# =====================================================
# DEPLOY QA
# =====================================================
- stage: Deploy_QA
  displayName: "Deploy to QA"
  dependsOn: Deploy_Dev
  jobs:
  - deployment: DeployQa
    displayName: "Publish DACPAC to QA"
    environment: qa
    pool:
      name: pool-local-docker
    strategy:
      runOnce:
        deploy:
          steps:
          - download: current
            artifact: drop

          - powershell: |
              $dacpac = Get-ChildItem "$(Pipeline.Workspace)\drop" -Recurse -Filter "*.dacpac" | Select-Object -First 1
              if (-not $dacpac) { throw "No .dacpac found in artifact." }

              # 1) Deploy report
              $reportPath = "$(Pipeline.Workspace)\deploy-report-qa.xml"

              SqlPackage `
                /Action:DeployReport `
                /SourceFile:"$($dacpac.FullName)" `
                /TargetServerName:"$(QaServer)" `
                /TargetDatabaseName:"$(TargetDatabaseName)" `
                /TargetUser:"$(SqlUser)" `
                /TargetPassword:"$env:SQL_SA_PASSWORD" `
                /TargetEncryptConnection:True `
                /TargetTrustServerCertificate:True `
                /OutputPath:"$reportPath"

              Write-Host "Deploy report generated: $reportPath"

              SqlPackage `
                /Action:Publish `
                /SourceFile:"$($dacpac.FullName)" `
                /TargetServerName:"$(QaServer)" `
                /TargetDatabaseName:"$(TargetDatabaseName)" `
                /TargetUser:"$(SqlUser)" `
                /TargetPassword:"$env:SQL_SA_PASSWORD" `
                /TargetEncryptConnection:True `
                /TargetTrustServerCertificate:True `
                /p:BlockOnPossibleDataLoss=True `
                /p:VerifyDeployment=True
            displayName: "Deploy QA (Safe Mode)"
            env:
              SQL_SA_PASSWORD: $(SQL_SA_PASSWORD)

          - task: PublishPipelineArtifact@1
            displayName: "Publish QA deploy report"
            inputs:
              targetPath: "$(Pipeline.Workspace)/deploy-report-qa.xml"
              artifact: "deploy-report-qa"

# =====================================================
# DRIFT DETECTION (QA)
# =====================================================
- stage: Drift_QA
  displayName: "Drift Detection (QA vs DACPAC)"
  dependsOn: Deploy_QA
  jobs:
  - job: DriftCheckQa
    displayName: "Detect drift in QA"
    pool:
      name: pool-local-docker
    steps:
    - download: current
      artifact: drop

    - powershell: |
        $dacpac = Get-ChildItem "$(Pipeline.Workspace)\drop" -Recurse -Filter "*.dacpac" | Select-Object -First 1
        if (-not $dacpac) { throw "No .dacpac found in artifact." }

        $reportPath = "$(Pipeline.Workspace)\drift-report-qa.xml"

        # DeployReport generates the diff between desired (DACPAC) and current (QA DB)
        SqlPackage `
          /Action:DeployReport `
          /SourceFile:"$($dacpac.FullName)" `
          /TargetServerName:"$(QaServer)" `
          /TargetDatabaseName:"$(TargetDatabaseName)" `
          /TargetUser:"$(SqlUser)" `
          /TargetPassword:"$env:SQL_SA_PASSWORD" `
          /TargetEncryptConnection:True `
          /TargetTrustServerCertificate:True `
          /OutputPath:"$reportPath"

        if (-not (Test-Path $reportPath)) { throw "Drift report not generated." }

        # If there are operations in the report, drift exists
        $xml = [xml](Get-Content $reportPath)
        $ops = $xml.DeploymentReport.Operations.Operation

        if ($null -ne $ops) {
          Write-Host "DRIFT DETECTED in QA. See drift report: $reportPath"
          throw "Drift detected in QA. Pipeline blocked."
        }

        Write-Host "No drift detected in QA."
      displayName: "Drift check (QA)"
      env:
        SQL_SA_PASSWORD: $(SQL_SA_PASSWORD)

    - task: PublishPipelineArtifact@1
      displayName: "Publish QA drift report"
      inputs:
        targetPath: "$(Pipeline.Workspace)/drift-report-qa.xml"
        artifact: "drift-report-qa"



# =====================================================
# DEPLOY STAGING
# =====================================================
- stage: Deploy_Staging
  displayName: "Deploy to Staging"
  dependsOn: Deploy_QA
  jobs:
  - deployment: DeployStaging
    displayName: "Publish DACPAC to Staging"
    environment: staging
    pool:
      name: pool-local-docker
    strategy:
      runOnce:
        deploy:
          steps:
          - download: current
            artifact: drop

          - powershell: |
              $dacpac = Get-ChildItem "$(Pipeline.Workspace)\drop" -Recurse -Filter "*.dacpac" | Select-Object -First 1
              if (-not $dacpac) { throw "No .dacpac found in artifact." }

              # 1) Deploy report
              $reportPath = "$(Pipeline.Workspace)\deploy-report-staging.xml"

              SqlPackage `
                /Action:DeployReport `
                /SourceFile:"$($dacpac.FullName)" `
                /TargetServerName:"$(StagingServer)" `
                /TargetDatabaseName:"$(TargetDatabaseName)" `
                /TargetUser:"$(SqlUser)" `
                /TargetPassword:"$env:SQL_SA_PASSWORD" `
                /TargetEncryptConnection:True `
                /TargetTrustServerCertificate:True `
                /OutputPath:"$reportPath"

              Write-Host "Deploy report generated: $reportPath"

              SqlPackage `
                /Action:Publish `
                /SourceFile:"$($dacpac.FullName)" `
                /TargetServerName:"$(StagingServer)" `
                /TargetDatabaseName:"$(TargetDatabaseName)" `
                /TargetUser:"$(SqlUser)" `
                /TargetPassword:"$env:SQL_SA_PASSWORD" `
                /TargetEncryptConnection:True `
                /TargetTrustServerCertificate:True `
                /p:BlockOnPossibleDataLoss=True `
                /p:VerifyDeployment=True
            displayName: "Deploy Staging (Safe Mode)"
            env:
              SQL_SA_PASSWORD: $(SQL_SA_PASSWORD)

          - task: PublishPipelineArtifact@1
            displayName: "Publish Staging deploy report"
            inputs:
              targetPath: "$(Pipeline.Workspace)/deploy-report-staging.xml"
              artifact: "deploy-report-staging"

# =====================================================
# DEPLOY PROD
# =====================================================
- stage: Deploy_Prod
  displayName: "Deploy to Prod"
  dependsOn: Deploy_Staging
  jobs:
  - deployment: DeployProd
    displayName: "Publish DACPAC to Prod"
    environment: prod
    pool:
      name: pool-local-docker
    strategy:
      runOnce:
        deploy:
          steps:
          - download: current
            artifact: drop

          - powershell: |
              $dacpac = Get-ChildItem "$(Pipeline.Workspace)\drop" -Recurse -Filter "*.dacpac" | Select-Object -First 1
              if (-not $dacpac) { throw "No .dacpac found in artifact." }

              # 1) Deploy report
              $reportPath = "$(Pipeline.Workspace)\deploy-report-prod.xml"
              SqlPackage `
                /Action:DeployReport `
                /SourceFile:"$($dacpac.FullName)" `
                /TargetServerName:"$(ProdServer)" `
                /TargetDatabaseName:"$(TargetDatabaseName)" `
                /TargetUser:"$(SqlUser)" `
                /TargetPassword:"$env:SQL_SA_PASSWORD" `
                /TargetEncryptConnection:True `
                /TargetTrustServerCertificate:True `
                /OutputPath:"$reportPath"

              SqlPackage `
                /Action:Publish `
                /SourceFile:"$($dacpac.FullName)" `
                /TargetServerName:"$(ProdServer)" `
                /TargetDatabaseName:"$(TargetDatabaseName)" `
                /TargetUser:"$(SqlUser)" `
                /TargetPassword:"$env:SQL_SA_PASSWORD" `
                /TargetEncryptConnection:True `
                /TargetTrustServerCertificate:True `
                /p:BlockOnPossibleDataLoss=True `
                /p:VerifyDeployment=True
            displayName: "Deploy Prod (Safe Mode)"
            env:
              SQL_SA_PASSWORD: $(SQL_SA_PASSWORD)

          - task: PublishPipelineArtifact@1
            displayName: "Publish Prod deploy report"
            inputs:
              targetPath: "$(Pipeline.Workspace)/deploy-report-prod.xml"
              artifact: "deploy-report-prod"
